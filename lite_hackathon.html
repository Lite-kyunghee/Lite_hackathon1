<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>L.I.T.E</title>
    <link rel="stylesheet" href="lite_hackathon.css" />
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  </head>

  <body>
    <!-- 사이드바 오버레이 -->
    <div class="overlay" id="overlay" aria-hidden="true"></div>

    <!-- 좌측 사이드바 -->
    <aside
      id="sidebar"
      class="sidebar"
      aria-label="부가기능 내비게이션"
      aria-hidden="true"
    >
      <header class="sidebar-header">
        <strong>부가기능</strong>
        <button
          class="icon-btn sm"
          id="closeSidebar"
          aria-label="사이드바 닫기"
        >
          <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
            <path
              d="M6 6l12 12M18 6L6 18"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
            />
          </svg>
        </button>
        <span id="widgetHint" class="widget-hint"
          >( + 버튼을 눌러 위젯을 추가하세요 )</span
        >
      </header>

      <nav class="sidebar-menu">
        <a href="suhang.html" class="menu-item">📝 수행평가</a>
        <a href="#" class="menu-item">📊 성적조회</a>
        <a href="#" class="menu-item">✅ 정기고사 모범답</a>
        <a href="gache.html" class="menu-item">🧮 정기고사 가채점</a>
        <a href="#" class="menu-item">📚 모의고사 학습</a>
        <a href="#" class="menu-item">🔔 알림신청</a>
        <a href="#" class="menu-item">🗂️ 경희 게시판</a>
        <a href="#" class="menu-item">💼 포트폴리오</a>
        <a href="#" class="menu-item">🧭 진로상담</a>
        <a href="haksa.html" class="menu-item">🗓️ 학교일정</a>
      </nav>

      <footer class="sidebar-footer">© <span id="year"></span> L.I.T.E</footer>
    </aside>

    <!-- 상단 헤더 -->
    <header class="header" role="banner">
      <button class="icon-btn" id="openSidebar" aria-label="메뉴 열기">
        <svg width="22" height="22" viewBox="0 0 24 24" aria-hidden="true">
          <path
            d="M3 6h18M3 12h18M3 18h18"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
          />
        </svg>
      </button>

      <div class="logo">L . I . T . E</div>

      <button class="icon-btn circle" id="loginBtn" title="로그인">
        <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
          <path
            d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"
            stroke="currentColor"
            stroke-width="2"
            fill="none"
            stroke-linecap="round"
          />
          <path
            d="M10 17l5-5-5-5"
            stroke="currentColor"
            stroke-width="2"
            fill="none"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path
            d="M15 12H3"
            stroke="currentColor"
            stroke-width="2"
            fill="none"
            stroke-linecap="round"
          />
        </svg>
      </button>
    </header>

    <!-- 메인 -->
    <main class="container" role="main">
      <!-- 검색 -->
      <form
        class="search"
        id="searchForm"
        role="search"
        aria-label="사이트 검색"
      >
        <span class="search-icon" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24">
            <circle
              cx="11"
              cy="11"
              r="7"
              stroke="currentColor"
              stroke-width="2"
              fill="none"
            />
            <path
              d="M20 20l-3.65-3.65"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
            />
          </svg>
        </span>
        <input
          id="q"
          type="search"
          placeholder="무엇이든 물어보세요..."
          autocomplete="off"
        />
      </form>

      <!-- 위젯 영역 -->
      <div class="stack">
        <section id="widgetGrid" class="widget-grid" aria-label="위젯 영역">
          <!-- 시간표 위젯 -->
          <article class="widget" data-widget="timetable">
            <header class="widget-header">
              <h3>시간표</h3>
              <button
                class="icon-btn sm remove-widget"
                title="위젯 삭제"
                aria-label="위젯 삭제"
              >
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  aria-hidden="true"
                >
                  <path
                    d="M6 6l12 12M18 6L6 18"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                  />
                </svg>
              </button>
            </header>
            <div class="widget-body">
              <div class="timetable"><div class="cells"></div></div>
            </div>
          </article>

          <!-- 오늘의 급식 -->
          <article class="widget" data-widget="lunch">
            <header class="widget-header">
              <h3>오늘의 급식</h3>
              <button
                class="icon-btn sm remove-widget"
                title="위젯 삭제"
                aria-label="위젯 삭제"
              >
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  aria-hidden="true"
                >
                  <path
                    d="M6 6l12 12M6 18L18 6"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                  />
                </svg>
              </button>
            </header>
            <div class="widget-body">
              <ul class="lunch-list" id="todayLunch">
                <li>로딩 중...</li>
              </ul>
            </div>
          </article>
        </section>

        <!-- 위젯 추가 버튼 -->
        <button
          id="fabAdd"
          class="fab"
          title="위젯 추가"
          aria-label="위젯 추가"
        >
          <svg width="22" height="22" viewBox="0 0 24 24" aria-hidden="true">
            <path
              d="M12 5v14M5 12h14"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
            />
          </svg>
        </button>
      </div>
    </main>

    <!-- 💬 채팅 패널 -->
    <aside id="chatbox" class="chat-panel" aria-label="채팅">
      <header class="chat-header">
        <span style="display: flex; align-items: center; gap: 6px"
          >💬 <strong>선생님과의 채팅</strong></span
        >
        <button id="toggleChat" class="icon-btn sm" title="접기">
          <svg
            width="14"
            height="14"
            viewBox="0 0 24 24"
            fill="none"
            stroke="white"
            stroke-width="2"
            stroke-linecap="round"
          >
            <path d="M18 15l-6-6-6 6" />
          </svg>
        </button>
      </header>

      <!-- 교사 선택 -->
      <div class="teacher-select">
        <label for="teacher">메일 전송 대상:</label>
        <select id="teacher">
          <option value="">선택하세요</option>
          <option value="greylove1111@gmail.com">최성윤 선생님</option>
        </select>
      </div>

      <div id="chatMessages" class="chat-messages"></div>

      <div class="chat-input">
        <input id="chatInput" type="text" placeholder="메시지를 입력하세요…" />
        <button id="sendBtn">전송</button>
      </div>
    </aside>

    <!-- 테마 전환 -->
    <button id="themeToggle" class="theme-toggle" title="모드 전환">🌙</button>

    <!-- JS -->
    <script src="lite_hackathon.js"></script>
    <script>
      const socket = io();
      const chatInput = document.getElementById('chatInput');
      const chatMessages = document.getElementById('chatMessages');
      const sendBtn = document.getElementById('sendBtn');
      const toggleChat = document.getElementById('toggleChat');
      const chatBox = document.getElementById('chatbox');
      const teacherSelect = document.getElementById('teacher');

      let folded = false;
      let chatHistory = [];

      function addMsg(text, who = 'you') {
        const div = document.createElement('div');
        div.className = 'msg' + (who === 'me' ? ' me' : '');
        div.textContent = text;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        chatHistory.push((who === 'me' ? '나: ' : '선생님: ') + text);
      }

      sendBtn.addEventListener('click', () => {
        const msg = chatInput.value.trim();
        if (!msg) return;
        addMsg(msg, 'me');
        socket.emit('message', msg);
        chatInput.value = '';

        const email = teacherSelect.value;
        if (email) {
          fetch('/send_gmail', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              email: email,
              content: chatHistory.join('\n'),
            }),
          })
            .then((res) => res.json())
            .then((data) => {
              if (data.status === 'ok') {
                addMsg(`✅ 대화 내용이 ${email} 로 전송되었습니다.`);
              } else {
                addMsg(`⚠️ 메일 전송 실패: ${data.message}`);
              }
            })
            .catch((err) => addMsg('⚠️ 네트워크 오류: ' + err.message));
        }
      });

      socket.on('message', (msg) => addMsg(msg, 'you'));

      toggleChat.addEventListener('click', () => {
        folded = !folded;
        chatBox.classList.toggle('folded', folded);
        toggleChat.innerHTML = folded
          ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round"><path d="M6 9l6 6 6-6" /></svg>'
          : '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round"><path d="M18 15l-6-6-6 6" /></svg>';
      });
    </script>
  </body>
</html>
